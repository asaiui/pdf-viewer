<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å‰²ãƒœã‚¿ãƒ³ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="debug-panel">
        <h1>ğŸ” åˆ†å‰²ãƒœã‚¿ãƒ³ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        <p>ã“ã®ç”»é¢ã§ã¯åˆ†å‰²ãƒœã‚¿ãƒ³ãŒå‹•ä½œã—ãªã„å•é¡Œã‚’èª¿æŸ»ã—ã¾ã™ã€‚</p>
        
        <div class="status info" id="status">
            ğŸ”„ ãƒ‡ãƒãƒƒã‚°ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...
        </div>

        <button onclick="runDiagnostics()">ğŸ” è¨ºæ–­å®Ÿè¡Œ</button>
        <button onclick="testSplitButton()">ğŸ§ª åˆ†å‰²ãƒœã‚¿ãƒ³ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="checkEventListeners()">ğŸ‘‚ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç¢ºèª</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="debug-panel">
        <h2>ğŸ“‹ è¨ºæ–­ãƒ­ã‚°</h2>
        <pre id="debugLog">è¨ºæ–­ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</pre>
    </div>

    <script>
        let log = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            log.push(`[${timestamp}] ${message}`);
            updateLogDisplay();
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateLogDisplay() {
            document.getElementById('debugLog').textContent = log.join('\n');
        }
        
        function clearLog() {
            log = [];
            updateLogDisplay();
            addLog('ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ', 'info');
        }
        
        function runDiagnostics() {
            addLog('=== åˆ†å‰²ãƒœã‚¿ãƒ³è¨ºæ–­é–‹å§‹ ===', 'info');
            
            // 1. ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
            const checkMainApp = () => {
                if (window.opener) {
                    const mainWindow = window.opener;
                    addLog('âœ… ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', 'success');
                    
                    // ISCPDFViewerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç¢ºèª
                    if (mainWindow.document.querySelector('.container')) {
                        addLog('âœ… PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ã¾ã™', 'success');
                        
                        // åˆ†å‰²ãƒœã‚¿ãƒ³ã®å­˜åœ¨ç¢ºèª
                        const splitBtn = mainWindow.document.getElementById('splitBtn');
                        if (splitBtn) {
                            addLog('âœ… åˆ†å‰²ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', 'success');
                            addLog(`ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: "${splitBtn.textContent}"`, 'info');
                            addLog(`ãƒœã‚¿ãƒ³ã‚¯ãƒ©ã‚¹: "${splitBtn.className}"`, 'info');
                            
                            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç¢ºèª
                            checkButtonEventListeners(splitBtn);
                            
                        } else {
                            addLog('âŒ åˆ†å‰²ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        }
                        
                        // WebPViewerã®ç¢ºèª
                        checkWebPViewer(mainWindow);
                        
                    } else {
                        addLog('âŒ PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                } else {
                    addLog('âŒ ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', 'error');
                    addLog('ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„', 'warning');
                }
            };
            
            checkMainApp();
        }
        
        function checkButtonEventListeners(button) {
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å­˜åœ¨ç¢ºèªï¼ˆé™å®šçš„ï¼‰
            addLog('ğŸ” ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç¢ºèªä¸­...', 'info');
            
            // onclickå±æ€§ã®ç¢ºèª
            if (button.onclick) {
                addLog('âœ… onclickå±æ€§ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™', 'success');
            } else {
                addLog('âš ï¸ onclickå±æ€§ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
            }
            
            // addEventListenerã§è¿½åŠ ã•ã‚ŒãŸãƒªã‚¹ãƒŠãƒ¼ã¯ç›´æ¥ç¢ºèªã§ããªã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯ã‚’å®Ÿè¡Œ
            addLog('ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™...', 'info');
        }
        
        function checkWebPViewer(mainWindow) {
            try {
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ WebPViewer ã‚’æ¢ã™
                addLog('ğŸ” WebPViewerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºèªä¸­...', 'info');
                
                // æ§˜ã€…ãªæ–¹æ³•ã§WebPViewerã«ã‚¢ã‚¯ã‚»ã‚¹
                let webpViewer = null;
                
                if (mainWindow.viewer && mainWindow.viewer.svgViewer) {
                    webpViewer = mainWindow.viewer.svgViewer;
                    addLog('âœ… viewer.svgViewerçµŒç”±ã§WebPViewerãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', 'success');
                } else {
                    addLog('âŒ WebPViewerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // WebPViewerã®ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
                if (webpViewer.toggleSplitMode) {
                    addLog('âœ… toggleSplitMode ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã™', 'success');
                } else {
                    addLog('âŒ toggleSplitMode ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                }
                
                // åˆ†å‰²ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç¢ºèª
                addLog(`åˆ†å‰²ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹: ${webpViewer.splitMode || false}`, 'info');
                addLog(`åˆ†å‰²ã‚µã‚¤ãƒ‰: ${webpViewer.splitSide || 'left'}`, 'info');
                
            } catch (error) {
                addLog(`âŒ WebPViewerç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function testSplitButton() {
            addLog('=== åˆ†å‰²ãƒœã‚¿ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'info');
            
            if (window.opener) {
                const mainWindow = window.opener;
                const splitBtn = mainWindow.document.getElementById('splitBtn');
                
                if (splitBtn) {
                    addLog('ğŸ§ª åˆ†å‰²ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ', 'info');
                    
                    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã—ã¦ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒƒãƒ
                    const originalConsoleLog = mainWindow.console.log;
                    mainWindow.console.log = function(...args) {
                        if (args[0] && args[0].toString().includes('Split')) {
                            addLog(`ğŸ“ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°: ${args.join(' ')}`, 'info');
                        }
                        originalConsoleLog.apply(this, args);
                    };
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
                    splitBtn.click();
                    
                    setTimeout(() => {
                        mainWindow.console.log = originalConsoleLog;
                        addLog('âœ… ãƒ†ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯å®Œäº†', 'success');
                    }, 500);
                    
                } else {
                    addLog('âŒ åˆ†å‰²ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆã§ãã¾ã›ã‚“', 'error');
                }
            } else {
                addLog('âŒ ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', 'error');
            }
        }
        
        function checkEventListeners() {
            addLog('=== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è©³ç´°ç¢ºèª ===', 'info');
            
            if (window.opener) {
                const mainWindow = window.opener;
                
                // EventManagerã®çŠ¶æ…‹ç¢ºèª
                if (mainWindow.viewer && mainWindow.viewer.eventManager) {
                    addLog('âœ… EventManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', 'success');
                    const stats = mainWindow.viewer.eventManager.getStats();
                    addLog(`EventManagerçµ±è¨ˆ: ${JSON.stringify(stats, null, 2)}`, 'info');
                } else {
                    addLog('âš ï¸ EventManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
                
                // æ‰‹å‹•ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šã‚’ç¢ºèª
                const splitBtn = mainWindow.document.getElementById('splitBtn');
                if (splitBtn) {
                    // DOMè¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆç¢ºèª
                    addLog('ğŸ” DOMè¦ç´ ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç¢ºèª:', 'info');
                    addLog(`disabled: ${splitBtn.disabled}`, 'info');
                    addLog(`style.display: ${splitBtn.style.display}`, 'info');
                    addLog(`offsetParent: ${splitBtn.offsetParent ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º'}`, 'info');
                }
            }
        }
        
        // åˆå›å®Ÿè¡Œ
        window.addEventListener('load', () => {
            addLog('ğŸš€ åˆ†å‰²ãƒœã‚¿ãƒ³ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ãŒèµ·å‹•ã—ã¾ã—ãŸ', 'success');
            setTimeout(runDiagnostics, 1000);
        });
        
        // ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'debug') {
                addLog(`ğŸ“¨ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³: ${event.data.message}`, 'info');
            }
        });
    </script>
</body>
</html>