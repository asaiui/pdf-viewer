// PDF.jsã®è¨­å®š
pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

class ISCPDFViewer {
    constructor() {
        this.pdf = null;
        this.currentPage = 1;
        this.totalPages = 0;
        this.scale = 1.0;
        this.canvas = document.getElementById('pdfCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.pageInput = document.getElementById('pageInput');
        this.totalPagesSpan = document.getElementById('totalPages');
        this.sidebarTotalPages = document.getElementById('sidebarTotalPages');
        this.loadingIndicator = document.getElementById('loadingIndicator');
        this.loadStatus = document.getElementById('loadStatus');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.zoomDisplay = document.getElementById('zoomDisplay');
        this.zoomLevelIndicator = document.getElementById('zoomLevelIndicator');
        this.pdfViewerContainer = document.getElementById('pdfViewerContainer');

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åˆ¶å¾¡ç”¨
        this.currentRenderTask = null;
        this.renderQueue = [];
        this.isRendering = false;
        this.renderTimeout = null;

        // ã‚ºãƒ¼ãƒ ãƒ»å…¨ç”»é¢åˆ¶å¾¡ç”¨
        this.baseScale = 1.0;
        this.currentZoom = 1.2; // åˆæœŸè¡¨ç¤ºã‚’20%å¤§ãã
        this.isFullscreen = false;
        this.isDragging = false;
        this.dragStart = { x: 0, y: 0 };
        this.canvasPosition = { x: 0, y: 0 };

        this.initializeEventListeners();
        this.initializeMobileMenu();
        this.loadPDF();
    }

    async loadPDF() {
        try {
            this.updateLoadStatus('ğŸ“¥ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ä¸­...');
            this.updateProgress(0, 'åˆæœŸåŒ–ä¸­...');

            // å®Ÿéš›ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆä¿¡é ¼æ€§é‡è¦–ã®è¨­å®šï¼‰
            const pdfUrl = 'pdf/250307_å­¦æ ¡æ¡ˆå†…2026æœ€çµ‚ãƒ‡ãƒ¼ã‚¿_A3è¦‹é–‹ã_æƒ…å ±ç§‘å­¦å°‚é–€å­¦æ ¡æ§˜ (1).pdf';
            
            // ã‚ˆã‚Šç¢ºå®Ÿãªèª­ã¿è¾¼ã¿è¨­å®š
            const loadingTask = pdfjsLib.getDocument({
                url: pdfUrl,
                // åŸºæœ¬çš„ãªè¨­å®šã®ã¿ä½¿ç”¨ï¼ˆäº’æ›æ€§é‡è¦–ï¼‰
                disableRange: false,
                disableStream: false,
                disableAutoFetch: false, // è‡ªå‹•ãƒ•ã‚§ãƒƒãƒã‚’æœ‰åŠ¹åŒ–
                cMapPacked: true,
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
                httpHeaders: {
                    'Cache-Control': 'no-cache'
                },
                // ã‚ˆã‚Šå¤§ããªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º
                maxImageSize: 4096 * 4096,
                // ã‚¨ãƒ©ãƒ¼è€æ€§ã‚’å‘ä¸Š
                stopAtErrors: false
            });

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
            loadingTask.onProgress = (progress) => {
                if (progress.total > 0) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    this.updateLoadStatus(`ğŸ“¥ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ä¸­... (${percent}%)`);
                    this.updateProgress(percent * 0.8, `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­... ${percent}%`); // 80%ã¾ã§ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å‰²ã‚Šå½“ã¦
                }
            };

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§èª­ã¿è¾¼ã¿
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('PDFèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 30000)
            );

            this.pdf = await Promise.race([loadingTask.promise, timeoutPromise]);
            this.totalPages = this.pdf.numPages;
            this.totalPagesSpan.textContent = this.totalPages;
            this.sidebarTotalPages.textContent = `${this.totalPages}ãƒšãƒ¼ã‚¸`;

            this.updateProgress(85, 'PDFè§£æå®Œäº†');
            this.updateLoadStatus('ğŸ¨ ãƒšãƒ¼ã‚¸ã‚’æç”»ä¸­...');

            // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’å³åº§ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            await this.renderPage(this.currentPage);
            this.updateControls();
            this.updateZoomDisplay();

            this.updateProgress(95, 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†');

            // UIã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            setTimeout(() => {
                this.updateProgress(100, 'èª­ã¿è¾¼ã¿å®Œäº†');
                
                setTimeout(() => {
                    this.loadingIndicator.style.display = 'none';
                    this.canvas.style.display = 'block';
                    this.canvas.classList.add('fade-in');
                }, 300);
            }, 200);

            this.updateLoadStatus('âœ… å­¦æ ¡æ¡ˆå†…PDFã‚’è¡¨ç¤ºä¸­');

            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã¯é…å»¶å®Ÿè¡Œï¼ˆãƒ¡ã‚¤ãƒ³èª­ã¿è¾¼ã¿ã®è² è·ã‚’è»½æ¸›ï¼‰
            setTimeout(() => {
                this.preloadAdjacentPages();
                this.analyzePDFContent();
            }, 1000);

        } catch (error) {
            console.error('PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            
            // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
            let errorMessage = 'PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            if (error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                errorMessage = 'PDFèª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            } else if (error.message.includes('404') || error.message.includes('Not Found')) {
                errorMessage = 'PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            } else if (error.message.includes('CORS')) {
                errorMessage = 'PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
            }
            
            this.showError(errorMessage + ' ãƒ‡ãƒ¢è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
            this.showDemoContent();
        }
    }

    // PDFã®å†…å®¹ã‚’åˆ†æã—ã¦å®Ÿéš›ã®ãƒšãƒ¼ã‚¸æ§‹æˆã‚’æŠŠæ¡ï¼ˆè»½é‡ç‰ˆï¼‰
    async analyzePDFContent() {
        if (!this.pdf) return;

        console.log('PDFã®å†…å®¹ã‚’åˆ†æä¸­...');
        const pageAnalysis = [];

        try {
            // åˆ†æãƒšãƒ¼ã‚¸æ•°ã‚’æ¸›ã‚‰ã—ã¦è² è·è»½æ¸›ï¼ˆæœ€åˆã®5ãƒšãƒ¼ã‚¸ã®ã¿ï¼‰
            const maxPagesToAnalyze = Math.min(this.totalPages, 5);
            
            for (let pageNum = 1; pageNum <= maxPagesToAnalyze; pageNum++) {
                try {
                    const page = await this.pdf.getPage(pageNum);
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œ
                    const textPromise = page.getTextContent();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 5000)
                    );
                    
                    const textContent = await Promise.race([textPromise, timeoutPromise]);
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆæœ€å¤§1000æ–‡å­—ã¾ã§ï¼‰
                    const text = textContent.items
                        .map(item => item.str)
                        .join(' ')
                        .substring(0, 1000);
                    
                    // ãƒšãƒ¼ã‚¸ã®ç‰¹å¾´ã‚’åˆ†æ
                    const analysis = this.analyzePageContent(pageNum, text);
                    pageAnalysis.push(analysis);
                    
                    console.log(`ãƒšãƒ¼ã‚¸ ${pageNum}:`, analysis);
                    
                } catch (error) {
                    console.warn(`ãƒšãƒ¼ã‚¸ ${pageNum} ã®åˆ†æã«å¤±æ•—:`, error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ†æçµæœã‚’è¿½åŠ 
                    pageAnalysis.push({
                        pageNumber: pageNum,
                        type: pageNum === 1 ? 'cover' : 'unknown',
                        title: pageNum === 1 ? 'è¡¨ç´™' : `ãƒšãƒ¼ã‚¸ ${pageNum}`,
                        keywords: [],
                        textLength: 0
                    });
                }
            }

            // åˆ†æçµæœã‚’ãƒ­ã‚°å‡ºåŠ›
            console.log('PDFåˆ†æçµæœ:', pageAnalysis);
            
            // å®Ÿéš›ã®æ§‹æˆã«åŸºã¥ã„ã¦ç›®æ¬¡ã‚’å‹•çš„ã«æ›´æ–°
            this.updateTableOfContents(pageAnalysis);

        } catch (error) {
            console.error('PDFå†…å®¹åˆ†æã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // ãƒšãƒ¼ã‚¸å†…å®¹ã®ç‰¹å¾´ã‚’åˆ†æ
    analyzePageContent(pageNum, text) {
        const analysis = {
            pageNumber: pageNum,
            type: 'unknown',
            title: '',
            keywords: [],
            textLength: text.length
        };

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’å°æ–‡å­—ã«å¤‰æ›ã—ã¦è§£æ
        const lowerText = text.toLowerCase();

        // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
        if (pageNum === 1) {
            analysis.type = 'cover';
            analysis.title = 'è¡¨ç´™';
        } else if (lowerText.includes('ç›®æ¬¡') || lowerText.includes('contents')) {
            analysis.type = 'toc';
            analysis.title = 'ç›®æ¬¡';
        } else if (lowerText.includes('å­¦æ ¡é•·') || lowerText.includes('æ ¡é•·') || lowerText.includes('ã‚ã„ã•ã¤')) {
            analysis.type = 'greeting';
            analysis.title = 'å­¦æ ¡é•·ã‚ã„ã•ã¤';
        } else if (lowerText.includes('é­…åŠ›') || lowerText.includes('ç‰¹è‰²') || lowerText.includes('ç‰¹å¾´')) {
            analysis.type = 'features';
            analysis.title = 'ISCã®é­…åŠ›';
        } else if (lowerText.includes('å¤§å­¦') && lowerText.includes('é•ã„')) {
            analysis.type = 'comparison';
            analysis.title = 'å¤§å­¦ã¨ã®é•ã„';
        } else if (lowerText.includes('æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£')) {
            analysis.type = 'department';
            analysis.title = 'æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç§‘';
        } else if (lowerText.includes('ai') || lowerText.includes('äººå·¥çŸ¥èƒ½')) {
            analysis.type = 'department';
            analysis.title = 'å®Ÿè·µAIç§‘';
        } else if (lowerText.includes('ã‚·ã‚¹ãƒ†ãƒ ') && lowerText.includes('å…ˆç«¯')) {
            analysis.type = 'department';
            analysis.title = 'å…ˆç«¯ITã‚·ã‚¹ãƒ†ãƒ ç§‘';
        } else if (lowerText.includes('æƒ…å ±å‡¦ç†')) {
            analysis.type = 'department';
            analysis.title = 'æƒ…å ±å‡¦ç†ç§‘';
        } else if (lowerText.includes('iot')) {
            analysis.type = 'department';
            analysis.title = 'å®Ÿè·µIoTç§‘';
        } else if (lowerText.includes('web') || lowerText.includes('ã‚¦ã‚§ãƒ–')) {
            analysis.type = 'department';
            analysis.title = 'WebæŠ€è¡“ç§‘';
        } else if (lowerText.includes('ãƒ“ã‚¸ãƒã‚¹')) {
            analysis.type = 'department';
            analysis.title = 'ãƒ“ã‚¸ãƒã‚¹ç§‘';
        } else if (lowerText.includes('è³‡æ ¼')) {
            analysis.type = 'support';
            analysis.title = 'è³‡æ ¼å–å¾—ã‚µãƒãƒ¼ãƒˆ';
        } else if (lowerText.includes('å°±è·')) {
            analysis.type = 'support';
            analysis.title = 'å°±è·ã‚µãƒãƒ¼ãƒˆ';
        } else if (lowerText.includes('å’æ¥­ç”Ÿ') || lowerText.includes('å…ˆè¼©')) {
            analysis.type = 'graduates';
            analysis.title = 'å’æ¥­ç”Ÿã®å£°';
        } else if (lowerText.includes('æ–½è¨­') || lowerText.includes('è¨­å‚™')) {
            analysis.type = 'facilities';
            analysis.title = 'æ–½è¨­ãƒ»è¨­å‚™';
        } else if (lowerText.includes('ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹') || lowerText.includes('å­¦ç”Ÿç”Ÿæ´»')) {
            analysis.type = 'campus';
            analysis.title = 'ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ•';
        } else if (lowerText.includes('å­¦è²»') || lowerText.includes('å…¥å­¦')) {
            analysis.type = 'admission';
            analysis.title = 'å…¥å­¦ãƒ»å­¦è²»';
        } else if (lowerText.includes('ã‚¢ã‚¯ã‚»ã‚¹') || lowerText.includes('äº¤é€š')) {
            analysis.type = 'access';
            analysis.title = 'ã‚¢ã‚¯ã‚»ã‚¹';
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
        const keywords = ['æƒ…å ±', 'æŠ€è¡“', 'IT', 'AI', 'ã‚·ã‚¹ãƒ†ãƒ ', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'Web', 'IoT', 'ãƒ“ã‚¸ãƒã‚¹'];
        analysis.keywords = keywords.filter(keyword => lowerText.includes(keyword.toLowerCase()));

        return analysis;
    }

    // åˆ†æçµæœã«åŸºã¥ã„ã¦ç›®æ¬¡ã‚’å‹•çš„ã«æ›´æ–°
    updateTableOfContents(pageAnalysis) {
        console.log('ç›®æ¬¡ã‚’å‹•çš„ã«æ›´æ–°ä¸­...');
        
        // åˆ†æçµæœã‚’ã‚¿ã‚¤ãƒ—åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const groupedPages = {
            introduction: [],
            departments: [],
            support: [],
            facilities: [],
            admission: []
        };

        pageAnalysis.forEach(page => {
            switch (page.type) {
                case 'cover':
                case 'toc':
                case 'greeting':
                case 'features':
                case 'comparison':
                    groupedPages.introduction.push(page);
                    break;
                case 'department':
                    groupedPages.departments.push(page);
                    break;
                case 'support':
                case 'graduates':
                    groupedPages.support.push(page);
                    break;
                case 'facilities':
                case 'campus':
                    groupedPages.facilities.push(page);
                    break;
                case 'admission':
                case 'access':
                    groupedPages.admission.push(page);
                    break;
            }
        });

        // æ¤œå‡ºã•ã‚ŒãŸãƒšãƒ¼ã‚¸æƒ…å ±ã‚’å…ƒã«ç›®æ¬¡ãƒªãƒ³ã‚¯ã‚’æ›´æ–°
        this.updateTocLinks(groupedPages);
    }

    // ç›®æ¬¡ãƒªãƒ³ã‚¯ã‚’å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ç•ªå·ã§æ›´æ–°
    updateTocLinks(groupedPages) {
        // å­¦æ ¡ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        const introLinks = document.querySelectorAll('.toc-section:first-child .toc-link');
        groupedPages.introduction.forEach((page, index) => {
            if (introLinks[index]) {
                introLinks[index].setAttribute('data-page', page.pageNumber);
                if (page.title) {
                    introLinks[index].textContent = page.title;
                }
            }
        });

        // å­¦ç§‘ãƒ»ã‚³ãƒ¼ã‚¹ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        const deptLinks = document.querySelectorAll('.toc-section:nth-child(2) .toc-link');
        groupedPages.departments.forEach((page, index) => {
            if (deptLinks[index]) {
                deptLinks[index].setAttribute('data-page', page.pageNumber);
                if (page.title) {
                    deptLinks[index].textContent = page.title;
                }
            }
        });

        // ã‚µãƒãƒ¼ãƒˆä½“åˆ¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        const supportLinks = document.querySelectorAll('.toc-section:nth-child(3) .toc-link');
        groupedPages.support.forEach((page, index) => {
            if (supportLinks[index]) {
                supportLinks[index].setAttribute('data-page', page.pageNumber);
                if (page.title) {
                    supportLinks[index].textContent = page.title;
                }
            }
        });

        // æ–½è¨­ãƒ»ç’°å¢ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        const facilityLinks = document.querySelectorAll('.toc-section:nth-child(4) .toc-link');
        groupedPages.facilities.forEach((page, index) => {
            if (facilityLinks[index]) {
                facilityLinks[index].setAttribute('data-page', page.pageNumber);
                if (page.title) {
                    facilityLinks[index].textContent = page.title;
                }
            }
        });

        // å…¥å­¦æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        const admissionLinks = document.querySelectorAll('.toc-section:nth-child(5) .toc-link');
        groupedPages.admission.forEach((page, index) => {
            if (admissionLinks[index]) {
                admissionLinks[index].setAttribute('data-page', page.pageNumber);
                if (page.title) {
                    admissionLinks[index].textContent = page.title;
                }
            }
        });

        console.log('ç›®æ¬¡ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ');
    }

    // éš£æ¥ãƒšãƒ¼ã‚¸ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆè»½é‡ç‰ˆï¼‰
    async preloadAdjacentPages() {
        if (!this.pdf) return;

        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã®ã¿ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆè² è·è»½æ¸›ï¼‰
        const pagesToPreload = [];
        
        if (this.currentPage < this.totalPages) {
            pagesToPreload.push(this.currentPage + 1);
        }

        // éåŒæœŸã§ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆUIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
        pagesToPreload.forEach(async (pageNum) => {
            try {
                const pagePromise = this.pdf.getPage(pageNum);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 3000)
                );
                
                await Promise.race([pagePromise, timeoutPromise]);
                console.log(`ãƒšãƒ¼ã‚¸ ${pageNum} ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
            } catch (error) {
                console.warn(`ãƒšãƒ¼ã‚¸ ${pageNum} ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:`, error);
            }
        });
    }

    async renderPage(pageNumber = this.currentPage, forceRender = false) {
        if (!this.pdf) return;

        // æ—¢ã«åŒã˜ãƒšãƒ¼ã‚¸ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!forceRender && this.isRendering && this.currentRenderTask && this.currentRenderTask.pageNumber === pageNumber) {
            return;
        }

        // é€²è¡Œä¸­ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        if (this.currentRenderTask) {
            this.currentRenderTask.cancel();
        }

        this.isRendering = true;

        try {
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šç”¨ï¼‰
            const startTime = performance.now();
            
            const page = await this.pdf.getPage(pageNumber);
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒã‚§ãƒƒã‚¯
            if (!this.isRendering) return;

            const container = document.getElementById('pdfViewerContainer');
            const containerWidth = container.clientWidth - 20;
            const containerHeight = container.clientHeight - 20;

            const viewport = page.getViewport({
                scale: 1.0
            });

            // è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ï¼ˆã‚ˆã‚Šå¤§ããè¡¨ç¤ºã™ã‚‹ã‚ˆã†æ”¹å–„ï¼‰
            const scaleWidth = containerWidth / viewport.width;
            const scaleHeight = containerHeight / viewport.height;
            // å¹…åŸºæº–ã§ã®æ‹¡å¤§è¡¨ç¤ºï¼ˆèª­ã¿ã‚„ã™ã•ã‚’å„ªå…ˆï¼‰
            this.baseScale = Math.max(scaleWidth * 1.1, Math.min(scaleWidth, scaleHeight) * 1.2);
            this.scale = this.baseScale * this.currentZoom;

            const scaledViewport = page.getViewport({
                scale: this.scale
            });

            // Canvasè§£åƒåº¦ã‚’é«˜ã‚ã‚‹ï¼ˆRetinaå¯¾å¿œï¼‰
            const outputScale = window.devicePixelRatio || 1;
            this.canvas.width = Math.floor(scaledViewport.width * outputScale);
            this.canvas.height = Math.floor(scaledViewport.height * outputScale);
            this.canvas.style.width = Math.floor(scaledViewport.width) + 'px';
            this.canvas.style.height = Math.floor(scaledViewport.height) + 'px';

            const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

            const renderContext = {
                canvasContext: this.ctx,
                viewport: scaledViewport,
                transform: transform,
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                intent: 'display',
                enableWebGL: true,
                // é«˜å“è³ªãƒ†ã‚­ã‚¹ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                textLayerMode: 0 // ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
            };

            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
            const renderTask = page.render(renderContext);
            this.currentRenderTask = {
                task: renderTask,
                pageNumber: pageNumber,
                cancel: () => {
                    renderTask.cancel();
                    this.isRendering = false;
                }
            };

            await renderTask.promise;

            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†å¾Œã€ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã¨ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿UIæ›´æ–°
            if (pageNumber === this.currentPage) {
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç›®æ¬¡é …ç›®ã‚’æ›´æ–°
                this.updateActiveTocItem();

                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚é–“ã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆé–‹ç™ºç”¨ï¼‰
                const renderTime = performance.now() - startTime;
                console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber} ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚é–“: ${renderTime.toFixed(2)}ms`);
            }

        } catch (error) {
            if (error.name === 'RenderingCancelledException') {
                console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ`);
            } else {
                console.error('ãƒšãƒ¼ã‚¸æç”»ã‚¨ãƒ©ãƒ¼:', error);
                this.showDemoContent();
            }
        } finally {
            this.isRendering = false;
            this.currentRenderTask = null;
        }
    }

    showDemoContent() {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¨­å®šï¼ˆã‚ˆã‚Šå¤§ããè¡¨ç¤ºï¼‰
        const containerWidth = this.pdfViewerContainer.clientWidth - 20;
        const targetWidth = Math.max(800, Math.min(containerWidth * 0.9, 1200));
        const targetHeight = Math.max(1000, targetWidth * 1.3);
        
        this.canvas.width = targetWidth;
        this.canvas.height = targetHeight;
        this.canvas.style.width = targetWidth + 'px';
        this.canvas.style.height = targetHeight + 'px';

        // èƒŒæ™¯
        this.ctx.fillStyle = '#ffffff';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
        this.ctx.fillStyle = '#0066CC';
        this.ctx.fillRect(0, 0, this.canvas.width, 120);

        // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = 'bold 36px "Noto Sans JP", sans-serif';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('æƒ…å ±ç§‘å­¦å°‚é–€å­¦æ ¡', this.canvas.width / 2, 60);
        this.ctx.font = '24px "Noto Sans JP", sans-serif';
        this.ctx.fillText('å­¦æ ¡æ¡ˆå†… 2026', this.canvas.width / 2, 95);

        // ãƒšãƒ¼ã‚¸æƒ…å ±
        this.ctx.fillStyle = '#333333';
        this.ctx.font = '18px "Noto Sans JP", sans-serif';
        this.ctx.fillText(`ãƒšãƒ¼ã‚¸ ${this.currentPage} / ${this.totalPages || 57}`, this.canvas.width / 2, 160);

        // å­¦æ ¡ã®ç‰¹è‰²
        this.ctx.fillStyle = '#FF6600';
        this.ctx.font = 'bold 20px "Noto Sans JP", sans-serif';
        this.ctx.fillText('ç¥å¥ˆå·çœŒåˆã®ITå°‚é–€å­¦æ ¡ï¼ˆ1983å¹´å‰µç«‹ï¼‰', this.canvas.width / 2, 200);

        // å­¦ç§‘ä¸€è¦§
        this.ctx.fillStyle = '#333333';
        this.ctx.font = '16px "Noto Sans JP", sans-serif';
        this.ctx.textAlign = 'left';

        const sections = [
            'ğŸ”’ æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç§‘ï¼ˆ4å¹´åˆ¶ï¼‰',
            'ğŸ¤– å®Ÿè·µAIç§‘ï¼ˆ4å¹´åˆ¶ï¼‰',
            'ğŸ® å…ˆç«¯ITã‚·ã‚¹ãƒ†ãƒ ç§‘ï¼ˆ3å¹´åˆ¶ï¼‰',
            'ğŸ’» æƒ…å ±å‡¦ç†ç§‘ï¼ˆ2å¹´åˆ¶ï¼‰',
            'ğŸŒ å®Ÿè·µIoTç§‘ï¼ˆ2å¹´åˆ¶ï¼‰',
            'ğŸ¨ WebæŠ€è¡“ç§‘ï¼ˆ2å¹´åˆ¶ï¼‰',
            'ğŸ“Š ãƒ“ã‚¸ãƒã‚¹ç§‘ï¼ˆ2å¹´åˆ¶ï¼‰',
            'ğŸ“œ ITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç§‘ï¼ˆ1å¹´åˆ¶ï¼‰'
        ];

        sections.forEach((section, index) => {
            this.ctx.fillText(section, 60, 280 + (index * 40));
        });

        // ç‰¹å¾´ãƒ»å®Ÿç¸¾
        this.ctx.fillStyle = '#0066CC';
        this.ctx.font = 'bold 18px "Noto Sans JP", sans-serif';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('ğŸš‰ æ¨ªæµœé§…ã‹ã‚‰å¾’æ­©1åˆ†', this.canvas.width / 2, 680);
        this.ctx.fillText('ğŸ“ˆ å°±è·ç‡98.9%', this.canvas.width / 2, 720);
        this.ctx.fillText('ğŸ† è³‡æ ¼å–å¾—ã‚µãƒãƒ¼ãƒˆå……å®Ÿ', this.canvas.width / 2, 760);
        this.ctx.fillText('ğŸ’¼ å¤§æ‰‹ä¼æ¥­ã¸ã®å°±è·å®Ÿç¸¾å¤šæ•°', this.canvas.width / 2, 800);

        // ãƒ•ãƒƒã‚¿ãƒ¼
        this.ctx.fillStyle = '#666666';
        this.ctx.font = '14px "Noto Sans JP", sans-serif';
        this.ctx.fillText('å²©å´å­¦åœ’ - 97å¹´ã®æ•™è‚²å®Ÿç¸¾', this.canvas.width / 2, 850);
        this.ctx.fillText('ã€’221-0835 æ¨ªæµœå¸‚ç¥å¥ˆå·åŒºé¶´å±‹ç”º2-17', this.canvas.width / 2, 880);

        // ãƒ‡ãƒ¢è¡¨ç¤ºã®å ´åˆã®ç·ãƒšãƒ¼ã‚¸æ•°è¨­å®š
        if (!this.totalPages) {
            this.totalPages = 57;
            this.totalPagesSpan.textContent = this.totalPages;
            this.sidebarTotalPages.textContent = `${this.totalPages}ãƒšãƒ¼ã‚¸`;
            this.updateControls();
        }
        
        // åˆæœŸã‚ºãƒ¼ãƒ è¡¨ç¤ºã‚’æ›´æ–°
        this.updateZoomDisplay();
    }

    updateLoadStatus(status) {
        this.loadStatus.textContent = status;
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
    updateProgress(percentage, text) {
        if (this.progressFill) {
            this.progressFill.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
        }
        if (this.progressText && text) {
            this.progressText.textContent = text;
        }
    }

    updateActiveTocItem() {
        // å…¨ã¦ã®ç›®æ¬¡ãƒªãƒ³ã‚¯ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        document.querySelectorAll('.toc-link').forEach(link => {
            link.classList.remove('active');
        });

        // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã«å¯¾å¿œã™ã‚‹ç›®æ¬¡é …ç›®ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        const currentLink = document.querySelector(`[data-page="${this.currentPage}"]`);
        if (currentLink) {
            currentLink.classList.add('active');
        }
    }

    goToPage(pageNumber) {
        const newPage = Math.max(1, Math.min(pageNumber, this.totalPages || 57));
        if (newPage !== this.currentPage) {
            this.currentPage = newPage;
            this.pageInput.value = this.currentPage;
            
            // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã§é€£ç¶šã‚¯ãƒªãƒƒã‚¯ã‚’åˆ¶å¾¡
            this.debouncedRenderPage(newPage);
            
            this.updateControls();
            this.updateFullscreenControls();
            this.updateLoadStatus(`ğŸ“„ ãƒšãƒ¼ã‚¸ ${this.currentPage} ã‚’è¡¨ç¤ºä¸­`);
            
            // ãƒšãƒ¼ã‚¸ç§»å‹•æ™‚ã«éš£æ¥ãƒšãƒ¼ã‚¸ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆé…å»¶å®Ÿè¡Œï¼‰
            setTimeout(() => this.preloadAdjacentPages(), 100);
        }
    }

    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    debouncedRenderPage(pageNumber) {
        // å‰å›ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (this.renderTimeout) {
            clearTimeout(this.renderTimeout);
        }

        // 50mså¾Œã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œï¼ˆé€£ç¶šæ“ä½œã‚’é˜²ãï¼‰
        this.renderTimeout = setTimeout(() => {
            this.renderPage(pageNumber);
        }, 50);
    }

    nextPage() {
        this.goToPage(this.currentPage + 1);
    }

    prevPage() {
        this.goToPage(this.currentPage - 1);
    }

    firstPage() {
        this.goToPage(1);
    }

    lastPage() {
        this.goToPage(this.totalPages || 57);
    }

    zoomIn() {
        this.currentZoom = Math.min(this.currentZoom * 1.2, 5.0);
        this.scale = this.baseScale * this.currentZoom;
        this.renderPage(this.currentPage, true);
        this.updateZoomDisplay();
        this.updateLoadStatus('ğŸ” æ‹¡å¤§è¡¨ç¤ºä¸­');
        this.updateCanvasClass();
    }

    zoomOut() {
        this.currentZoom = Math.max(this.currentZoom / 1.2, 0.3);
        this.scale = this.baseScale * this.currentZoom;
        this.renderPage(this.currentPage, true);
        this.updateZoomDisplay();
        this.updateLoadStatus('ğŸ” ç¸®å°è¡¨ç¤ºä¸­');
        this.updateCanvasClass();
    }

    setZoom(zoomLevel) {
        this.currentZoom = Math.max(0.3, Math.min(5.0, zoomLevel));
        this.scale = this.baseScale * this.currentZoom;
        this.renderPage(this.currentPage, true);
        this.updateZoomDisplay();
        this.updateCanvasClass();
    }

    updateZoomDisplay() {
        const percentage = Math.round(this.currentZoom * 100);
        if (this.zoomDisplay) {
            this.zoomDisplay.textContent = `${percentage}%`;
        }
        if (this.zoomLevelIndicator) {
            this.zoomLevelIndicator.textContent = `${percentage}%`;
        }
        
        // å…¨ç”»é¢æ™‚ã®è¡¨ç¤ºã‚‚æ›´æ–°
        const fullscreenZoomDisplay = document.getElementById('fullscreenZoomDisplay');
        if (fullscreenZoomDisplay) {
            fullscreenZoomDisplay.textContent = `${percentage}%`;
        }
    }

    updateCanvasClass() {
        if (this.currentZoom > 1.1) {
            this.canvas.classList.add('zoomable', 'zoomed');
        } else {
            this.canvas.classList.remove('zoomable', 'zoomed');
        }
    }

    fitToWidth() {
        // å¹…ã«åˆã‚ã›ã‚‹å ´åˆã¯ã‚ˆã‚Šå¤§ããè¡¨ç¤º
        this.currentZoom = 1.3;
        this.renderPage(this.currentPage, true);
        this.updateZoomDisplay();
        this.updateLoadStatus('ğŸ“ å¹…ã«åˆã‚ã›ã¦è¡¨ç¤º');
        this.updateCanvasClass();
    }

    fitToPage() {
        // å…¨ä½“è¡¨ç¤ºã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šå¤§ãã
        this.currentZoom = 1.1;
        this.renderPage(this.currentPage, true);
        this.updateZoomDisplay();
        this.updateLoadStatus('ğŸ“± å…¨ä½“è¡¨ç¤º');
        this.updateCanvasClass();
    }

    // å…¨ç”»é¢è¡¨ç¤ºæ©Ÿèƒ½
    toggleFullscreen() {
        if (this.isFullscreen) {
            this.exitFullscreen();
        } else {
            this.enterFullscreen();
        }
    }

    enterFullscreen() {
        this.isFullscreen = true;
        this.pdfViewerContainer.classList.add('fullscreen');
        
        // å…¨ç”»é¢APIä½¿ç”¨ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ï¼‰
        if (this.pdfViewerContainer.requestFullscreen) {
            this.pdfViewerContainer.requestFullscreen().catch(console.warn);
        } else if (this.pdfViewerContainer.webkitRequestFullscreen) {
            this.pdfViewerContainer.webkitRequestFullscreen();
        } else if (this.pdfViewerContainer.mozRequestFullScreen) {
            this.pdfViewerContainer.mozRequestFullScreen();
        }

        // å…¨ç”»é¢æ™‚ã®ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°
        this.updateFullscreenControls();
        
        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ç›´ã—ï¼ˆç”»é¢ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸãŸã‚ï¼‰
        setTimeout(() => {
            this.renderPage(this.currentPage, true);
        }, 100);

        this.updateLoadStatus('ğŸ”² å…¨ç”»é¢è¡¨ç¤ºä¸­');
    }

    exitFullscreen() {
        this.isFullscreen = false;
        this.pdfViewerContainer.classList.remove('fullscreen');
        
        // å…¨ç”»é¢APIçµ‚äº†
        if (document.exitFullscreen) {
            document.exitFullscreen().catch(console.warn);
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ç›´ã—
        setTimeout(() => {
            this.renderPage(this.currentPage, true);
        }, 100);

        this.updateLoadStatus('ğŸ“„ é€šå¸¸è¡¨ç¤º');
    }

    updateFullscreenControls() {
        const fullscreenCurrentPage = document.getElementById('fullscreenCurrentPage');
        const fullscreenTotalPages = document.getElementById('fullscreenTotalPages');
        
        if (fullscreenCurrentPage) {
            fullscreenCurrentPage.textContent = this.currentPage;
        }
        if (fullscreenTotalPages) {
            fullscreenTotalPages.textContent = this.totalPages || 57;
        }
    }

    updateControls() {
        const isFirstPage = this.currentPage === 1;
        const isLastPage = this.currentPage === (this.totalPages || 57);

        document.getElementById('firstPageBtn').disabled = isFirstPage;
        document.getElementById('prevPageBtn').disabled = isFirstPage;
        document.getElementById('nextPageBtn').disabled = isLastPage;
        document.getElementById('lastPageBtn').disabled = isLastPage;

        this.pageInput.max = this.totalPages || 57;
    }

    showError(message) {
        this.loadingIndicator.innerHTML = `
            <div style="color: var(--error); font-size: 24px;">âš ï¸</div>
            <div class="loading-text" style="color: var(--error);">${message}</div>
            <div class="loading-subtext">ãƒ‡ãƒ¢è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™...</div>
        `;

        this.updateLoadStatus('âš ï¸ PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•— - ãƒ‡ãƒ¢è¡¨ç¤ºä¸­');

        setTimeout(() => {
            this.loadingIndicator.style.display = 'none';
            this.canvas.style.display = 'block';
            this.canvas.classList.add('fade-in');
            this.totalPages = 57; // ãƒ‡ãƒ¢ç”¨ç·ãƒšãƒ¼ã‚¸æ•°
            this.totalPagesSpan.textContent = this.totalPages;
            this.sidebarTotalPages.textContent = `${this.totalPages}ãƒšãƒ¼ã‚¸ï¼ˆãƒ‡ãƒ¢ï¼‰`;
            this.showDemoContent();
            this.updateControls();
        }, 2000);
    }

    initializeEventListeners() {
        // ãƒšãƒ¼ã‚¸ç§»å‹•ãƒœã‚¿ãƒ³
        document.getElementById('firstPageBtn').addEventListener('click', () => this.firstPage());
        document.getElementById('prevPageBtn').addEventListener('click', () => this.prevPage());
        document.getElementById('nextPageBtn').addEventListener('click', () => this.nextPage());
        document.getElementById('lastPageBtn').addEventListener('click', () => this.lastPage());

        // ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³
        document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
        document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
        document.getElementById('fitWidthBtn').addEventListener('click', () => this.fitToWidth());
        document.getElementById('fitPageBtn').addEventListener('click', () => this.fitToPage());
        
        // å…¨ç”»é¢ãƒœã‚¿ãƒ³
        document.getElementById('fullscreenBtn').addEventListener('click', () => this.toggleFullscreen());
        
        // å…¨ç”»é¢æ™‚ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        document.getElementById('fullscreenPrevBtn').addEventListener('click', () => this.prevPage());
        document.getElementById('fullscreenNextBtn').addEventListener('click', () => this.nextPage());
        document.getElementById('fullscreenZoomInBtn').addEventListener('click', () => this.zoomIn());
        document.getElementById('fullscreenZoomOutBtn').addEventListener('click', () => this.zoomOut());
        document.getElementById('exitFullscreenBtn').addEventListener('click', () => this.exitFullscreen());

        // ãƒšãƒ¼ã‚¸å…¥åŠ›
        this.pageInput.addEventListener('change', (e) => {
            const pageNumber = parseInt(e.target.value);
            if (!isNaN(pageNumber)) {
                this.goToPage(pageNumber);
            }
        });

        this.pageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const pageNumber = parseInt(e.target.value);
                if (!isNaN(pageNumber)) {
                    this.goToPage(pageNumber);
                }
            }
        });

        // ç›®æ¬¡ãƒªãƒ³ã‚¯
        document.querySelectorAll('.toc-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageNumber = parseInt(e.target.dataset.page);
                this.goToPage(pageNumber);
                this.closeMobileMenu();
            });
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯ç„¡è¦–
            if (e.target.tagName === 'INPUT') return;

            switch (e.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                case 'PageUp':
                    e.preventDefault();
                    this.prevPage();
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                case 'PageDown':
                case ' ': // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼
                    e.preventDefault();
                    this.nextPage();
                    break;
                case 'Home':
                    e.preventDefault();
                    this.firstPage();
                    break;
                case 'End':
                    e.preventDefault();
                    this.lastPage();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    this.zoomIn();
                    break;
                case '-':
                case '_':
                    e.preventDefault();
                    this.zoomOut();
                    break;
                case 'f':
                case 'F':
                    if (e.ctrlKey || e.metaKey) {
                        // Ctrl+F ã¯é€šå¸¸ã®æ¤œç´¢ã¨ã—ã¦å‹•ä½œ
                        return;
                    }
                    e.preventDefault();
                    if (e.shiftKey) {
                        this.toggleFullscreen();
                    } else {
                        this.fitToPage();
                    }
                    break;
                case 'w':
                case 'W':
                    e.preventDefault();
                    this.fitToWidth();
                    break;
                case 'Escape':
                    if (this.isFullscreen) {
                        e.preventDefault();
                        this.exitFullscreen();
                    }
                    break;
            }
        });

        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                this.renderPage();
            }, 250);
        });

        // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®ã‚ºãƒ¼ãƒ ï¼ˆCtrlæŠ¼ä¸‹æ™‚ï¼‰
        this.canvas.addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    this.zoomIn();
                } else {
                    this.zoomOut();
                }
            }
        });
    }

    initializeMobileMenu() {
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        menuToggle.addEventListener('click', () => {
            this.toggleMobileMenu();
        });

        overlay.addEventListener('click', () => {
            this.closeMobileMenu();
        });

        // ESCã‚­ãƒ¼ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeMobileMenu();
            }
        });
    }

    toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');

        // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
        const isOpen = sidebar.classList.contains('open');
        document.getElementById('menuToggle').setAttribute('aria-expanded', isOpen);
    }

    closeMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        sidebar.classList.remove('open');
        overlay.classList.remove('active');

        document.getElementById('menuToggle').setAttribute('aria-expanded', 'false');
    }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
document.addEventListener('DOMContentLoaded', () => {
    // ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
    if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => {
            new ISCPDFViewer();
        });
    } else {
        new ISCPDFViewer();
    }
});

// ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        console.log('Service Workeræ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
    });
}